<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Antenne Books Stockist Database</title>
    <!-- Import Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier', monospace;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            padding: 20px;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'EB Garamond', serif;
            font-weight: 400;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #f1f3f4;
            padding-bottom: 20px;
        }

        h1 {
            color: #333333;
        }

        .back-link {
            color: #666;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid #666;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: #f1f3f4;
        }

        .settings-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .settings-section h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #555;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier', monospace;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 10px;
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .mapping-row input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier', monospace;
            font-size: 12px;
        }

        button {
            background: #000000;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background: #333333;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .status-message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #004085;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .import-export-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .import-export-box {
            flex: 1;
            padding: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .import-export-box h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .file-input-wrapper {
            margin: 15px 0;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .file-input-label:hover {
            background: #0056b3;
        }

        .file-name {
            margin-left: 10px;
            color: #666;
            font-size: 13px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .setting-description {
            flex: 1;
        }

        .setting-description h4 {
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }

        .setting-description p {
            color: #666;
            font-size: 12px;
            margin: 0;
        }

        .tab-container {
            margin-bottom: 30px;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .tab-button.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .danger-zone {
            background: #fff5f5;
            border: 2px solid #dc3545;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .danger-zone h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .danger-zone p {
            color: #721c24;
            margin-bottom: 15px;
            font-size: 13px;
        }

        /* User table styles */
        .user-row td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .user-row:hover {
            background-color: #f5f5f5;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Settings</h1>
            <a href="/" class="back-link">← Back to Dashboard</a>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <div class="tab-buttons">
                <div class="tab-button active" data-tab="general">General Settings</div>
                <div class="tab-button" data-tab="mappings">Customer Name Mappings</div>
                <div class="tab-button" data-tab="data">Data Management</div>
                <div class="tab-button" data-tab="users">Users</div>
                <div class="tab-button" data-tab="advanced">Advanced</div>
            </div>

            <!-- General Settings Tab -->
            <div id="general-tab" class="tab-content active">
                <div class="settings-section">
                    <h2>General Settings</h2>
                    
                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Auto-detect file types</h4>
                            <p>Automatically detect whether uploaded files are Gazelle or Shopify format</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoDetect" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Skip duplicate records</h4>
                            <p>Automatically skip duplicate records during upload based on order reference</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="skipDuplicates" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Default country for unknown locations</h4>
                            <p>Set the default country when location data is missing</p>
                        </div>
                        <select id="defaultCountry" style="width: 200px;">
                            <option value="Unknown">Unknown</option>
                            <option value="UK">United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="FR">France</option>
                            <option value="DE">Germany</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Default city for unknown locations</h4>
                            <p>Set the default city when location data is missing</p>
                        </div>
                        <input type="text" id="defaultCity" value="Unknown" style="width: 200px;">
                    </div>

                    <div class="action-buttons">
                        <button onclick="saveGeneralSettings()">Save General Settings</button>
                    </div>
                </div>
            </div>

            <!-- Customer Name Mappings Tab -->
            <div id="mappings-tab" class="tab-content">
                <div class="settings-section">
                    <h2>Customer Name Mappings</h2>
                    
                    <div class="info-box">
                        <strong>How it works:</strong>
                        Configure automatic customer name replacements here. When data is uploaded, any customer name matching the "Old Name" will be automatically replaced with the "New Name". This helps maintain consistent customer records across different data sources.
                    </div>

                    <h3>Current Mappings</h3>
                    <div id="mappingsList">
                        <!-- Mappings will be loaded here -->
                    </div>

                    <h3>Add New Mapping</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Old Customer Name</label>
                            <input type="text" id="oldName" placeholder="e.g., ANTENNE - DIRECT UK">
                        </div>
                        <div class="form-group">
                            <label>New Customer Name</label>
                            <input type="text" id="newName" placeholder="e.g., Antenne Online UK">
                        </div>
                        <button onclick="addMapping()" class="btn-success">Add Mapping</button>
                    </div>

                    <div class="import-export-section">
                        <div class="import-export-box">
                            <h4>Import Mappings</h4>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Upload a CSV file with columns: Old Name, New Name</p>
                            <div class="file-input-wrapper">
                                <label for="importFile" class="file-input-label">Choose CSV File</label>
                                <input type="file" id="importFile" accept=".csv" onchange="handleImportFile(event)">
                                <span id="importFileName" class="file-name">No file selected</span>
                            </div>
                            <button onclick="importMappings()" class="btn-secondary btn-small">Import</button>
                        </div>
                        
                        <div class="import-export-box">
                            <h4>Export Mappings</h4>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Download all current mappings as a CSV file</p>
                            <button onclick="exportMappings()" class="btn-secondary">Export to CSV</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Management Tab -->
            <div id="data-tab" class="tab-content">
                <div class="settings-section">
                    <h2>Data Management</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRecords">-</div>
                            <div class="stat-label">Total Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalCustomers">-</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalUploads">-</div>
                            <div class="stat-label">Total Uploads</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="excludedCustomers">-</div>
                            <div class="stat-label">Excluded Customers</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Backup & Restore</h3>
                    <div class="import-export-section">
                        <div class="import-export-box">
                            <h4>Backup Database</h4>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Download a complete backup of all records</p>
                            <button onclick="backupDatabase()" class="btn-success">Create Backup</button>
                        </div>
                        
                        <div class="import-export-box">
                            <h4>Export Customer List</h4>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Export all customer information to CSV</p>
                            <button onclick="exportCustomers()" class="btn-secondary">Export Customers</button>
                        </div>
                    </div>

                    <div class="danger-zone">
                        <h3>Danger Zone</h3>
                        <p>These actions are irreversible. Please be certain before proceeding.</p>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="clearAllRecords()" class="btn-danger">Clear All Records</button>
                            <button onclick="resetExclusions()" class="btn-danger">Reset All Exclusions</button>
                            <button onclick="clearUploadHistory()" class="btn-danger">Clear Upload History</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content">
                <div class="settings-section">
                    <h2>User Management</h2>
                    
                    <div class="info-box">
                        <strong>Manage System Users:</strong>
                        Create and manage user accounts for accessing the Antenne Books Stockist Database. Control who can view, upload, and manage data in your system.
                    </div>

                    <!-- Create/Edit User Form -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 id="userFormTitle">Create New User</h3>
                        <form id="userForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <input type="hidden" id="editingUserId">
                            
                            <div class="form-group">
                                <label for="username">Username *</label>
                                <input type="text" id="username" required placeholder="Enter username">
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" placeholder="user@example.com">
                            </div>
                            
                            <div class="form-group">
                                <label for="password">Password *</label>
                                <input type="password" id="password" placeholder="Min 6 characters">
                                <small style="color: #666; font-size: 11px;">Leave blank when editing to keep existing password</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="role">Role *</label>
                                <select id="role" required>
                                    <option value="admin">Admin - Full Access</option>
                                    <option value="editor">Editor - Can Upload & Edit</option>
                                    <option value="viewer" selected>Viewer - Read Only</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="grid-column: span 2;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="active" checked>
                                    <span>Active (User can log in)</span>
                                </label>
                            </div>
                            
                            <div style="grid-column: span 2; display: flex; gap: 10px;">
                                <button type="submit" class="btn-success" id="saveUserBtn">Create User</button>
                                <button type="button" onclick="resetUserForm()" class="btn-secondary">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <!-- Users Table -->
                    <h3>Existing Users</h3>
                    <div id="usersTableContainer">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #34495e; color: white;">
                                    <th style="padding: 12px; text-align: left; width: 60px;">ID</th>
                                    <th style="padding: 12px; text-align: left;">Username</th>
                                    <th style="padding: 12px; text-align: left;">Email</th>
                                    <th style="padding: 12px; text-align: left;">Role</th>
                                    <th style="padding: 12px; text-align: center; width: 100px;">Active</th>
                                    <th style="padding: 12px; text-align: center; width: 150px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                        <div id="noUsersMessage" class="no-data" style="display: none;">
                            No users found. Create your first user above.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div id="advanced-tab" class="tab-content">
                <div class="settings-section">
                    <h2>Advanced Settings</h2>
                    
                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Records per page</h4>
                            <p>Number of records to display per page in the upload view</p>
                        </div>
                        <input type="number" id="recordsPerPage" value="500" min="100" max="1000" step="100" style="width: 100px;">
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Enable debug logging</h4>
                            <p>Show detailed logging information in the browser console</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="debugLogging">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Database connection timeout (seconds)</h4>
                            <p>Maximum time to wait for database operations</p>
                        </div>
                        <input type="number" id="dbTimeout" value="30" min="10" max="120" style="width: 100px;">
                    </div>

                    <div class="action-buttons">
                        <button onclick="saveAdvancedSettings()">Save Advanced Settings</button>
                    </div>

                    <h3 style="margin-top: 30px;">System Information</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                        <p>Application Version: 1.0.0</p>
                        <p>Database: PostgreSQL on Railway</p>
                        <p>Node.js Version: 18.x</p>
                        <p>Last Updated: <span id="lastUpdated">-</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMappings = [];
        let importedFile = null;
        let users = [];
        let editingUserId = null;

        // Fixed Tab switching - using data attributes instead of event.target
        document.addEventListener('DOMContentLoaded', function() {
            // Add click listeners to all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName, this);
                });
            });
            
            // Load initial data
            loadSettings();
            loadUsers();
            
            // Add user form submit handler
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
        });

        // Fixed switchTab function
        function switchTab(tabName, buttonElement) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            const tabElement = document.getElementById(`${tabName}-tab`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Add active class to clicked button
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
        }

        // Show status message
        function showStatus(message, type = 'success') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Load current settings and mappings
        async function loadSettings() {
            try {
                // Load mappings
                const response = await fetch('/api/settings/mappings');
                if (response.ok) {
                    currentMappings = await response.json();
                    displayMappings();
                }

                // Load statistics
                loadStatistics();
                
                // Load general settings
                loadGeneralSettings();
                
                // Set last updated
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error loading settings:', error);
                showStatus('Error loading settings', 'error');
            }
        }

        // Display current mappings
        function displayMappings() {
            const container = document.getElementById('mappingsList');
            
            if (currentMappings.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No mappings configured yet</p>';
                return;
            }
            
            container.innerHTML = currentMappings.map((mapping, index) => `
                <div class="mapping-row">
                    <input type="text" value="${mapping.oldName}" readonly style="background: #f8f9fa;">
                    <input type="text" value="${mapping.newName}" readonly style="background: #f8f9fa;">
                    <button onclick="removeMapping(${index})" class="btn-danger btn-small">Remove</button>
                </div>
            `).join('');
        }

        // Add new mapping
        async function addMapping() {
            const oldName = document.getElementById('oldName').value.trim();
            const newName = document.getElementById('newName').value.trim();
            
            if (!oldName || !newName) {
                showStatus('Please enter both old and new customer names', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/settings/mappings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ oldName, newName })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentMappings = result.mappings;
                    displayMappings();
                    
                    // Clear inputs
                    document.getElementById('oldName').value = '';
                    document.getElementById('newName').value = '';
                    
                    showStatus('Mapping added successfully');
                } else {
                    throw new Error('Failed to add mapping');
                }
            } catch (error) {
                showStatus('Error adding mapping', 'error');
            }
        }

        // Remove mapping
        async function removeMapping(index) {
            if (!confirm('Are you sure you want to remove this mapping?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/settings/mappings/${index}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentMappings = result.mappings;
                    displayMappings();
                    showStatus('Mapping removed successfully');
                } else {
                    throw new Error('Failed to remove mapping');
                }
            } catch (error) {
                showStatus('Error removing mapping', 'error');
            }
        }

        // Handle import file selection
        function handleImportFile(event) {
            importedFile = event.target.files[0];
            document.getElementById('importFileName').textContent = importedFile ? importedFile.name : 'No file selected';
        }

        // Import mappings from CSV
        async function importMappings() {
            if (!importedFile) {
                showStatus('Please select a CSV file to import', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const mappings = [];
                    
                    for (let i = 1; i < lines.length; i++) { // Skip header
                        const line = lines[i].trim();
                        if (line) {
                            const [oldName, newName] = line.split(',').map(s => s.trim().replace(/"/g, ''));
                            if (oldName && newName) {
                                mappings.push({ oldName, newName });
                            }
                        }
                    }
                    
                    if (mappings.length === 0) {
                        showStatus('No valid mappings found in file', 'error');
                        return;
                    }
                    
                    const response = await fetch('/api/settings/mappings/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ mappings })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        currentMappings = result.mappings;
                        displayMappings();
                        showStatus(`Imported ${mappings.length} mappings successfully`);
                        
                        // Clear file input
                        document.getElementById('importFile').value = '';
                        document.getElementById('importFileName').textContent = 'No file selected';
                        importedFile = null;
                    } else {
                        throw new Error('Failed to import mappings');
                    }
                } catch (error) {
                    showStatus('Error importing mappings', 'error');
                }
            };
            
            reader.readAsText(importedFile);
        }

        // Export mappings to CSV
        function exportMappings() {
            if (currentMappings.length === 0) {
                showStatus('No mappings to export', 'error');
                return;
            }
            
            const csv = [
                'Old Name,New Name',
                ...currentMappings.map(m => `"${m.oldName}","${m.newName}"`)
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customer_mappings_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('Mappings exported successfully');
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/api/settings/statistics');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalRecords').textContent = stats.totalRecords.toLocaleString();
                    document.getElementById('totalCustomers').textContent = stats.totalCustomers.toLocaleString();
                    document.getElementById('totalUploads').textContent = stats.totalUploads.toLocaleString();
                    document.getElementById('excludedCustomers').textContent = stats.excludedCustomers.toLocaleString();
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load general settings
        async function loadGeneralSettings() {
            try {
                const response = await fetch('/api/settings/general');
                if (response.ok) {
                    const settings = await response.json();
                    
                    // Apply settings to UI
                    if (settings.autoDetect !== undefined) {
                        document.getElementById('autoDetect').checked = settings.autoDetect;
                    }
                    if (settings.skipDuplicates !== undefined) {
                        document.getElementById('skipDuplicates').checked = settings.skipDuplicates;
                    }
                    if (settings.defaultCountry) {
                        document.getElementById('defaultCountry').value = settings.defaultCountry;
                    }
                    if (settings.defaultCity) {
                        document.getElementById('defaultCity').value = settings.defaultCity;
                    }
                }
            } catch (error) {
                console.error('Error loading general settings:', error);
            }
        }

        // Save general settings
        async function saveGeneralSettings() {
            const settings = {
                autoDetect: document.getElementById('autoDetect').checked,
                skipDuplicates: document.getElementById('skipDuplicates').checked,
                defaultCountry: document.getElementById('defaultCountry').value,
                defaultCity: document.getElementById('defaultCity').value
            };
            
            try {
                const response = await fetch('/api/settings/general', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    showStatus('General settings saved successfully');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                showStatus('Error saving settings', 'error');
            }
        }

        // Save advanced settings
        async function saveAdvancedSettings() {
            const settings = {
                recordsPerPage: document.getElementById('recordsPerPage').value,
                debugLogging: document.getElementById('debugLogging').checked,
                dbTimeout: document.getElementById('dbTimeout').value
            };
            
            try {
                const response = await fetch('/api/settings/advanced', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    showStatus('Advanced settings saved successfully');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                showStatus('Error saving settings', 'error');
            }
        }

        // Backup database
        async function backupDatabase() {
            try {
                const response = await fetch('/api/backup');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `antenne_backup_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showStatus('Database backed up successfully');
                } else {
                    throw new Error('Backup failed');
                }
            } catch (error) {
                showStatus('Error creating backup', 'error');
            }
        }

        // Export customers
        async function exportCustomers() {
            try {
                const response = await fetch('/api/export/customers');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `customers_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showStatus('Customers exported successfully');
                } else {
                    throw new Error('Export failed');
                }
            } catch (error) {
                showStatus('Error exporting customers', 'error');
            }
        }

        // Clear all records
        async function clearAllRecords() {
            if (!confirm('Are you sure you want to DELETE ALL RECORDS? This cannot be undone!')) {
                return;
            }
            
            if (!confirm('This will permanently delete ALL sales records. Are you absolutely sure?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/settings/clear-records', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showStatus('All records cleared successfully');
                    loadStatistics();
                } else {
                    throw new Error('Failed to clear records');
                }
            } catch (error) {
                showStatus('Error clearing records', 'error');
            }
        }

        // Reset exclusions
        async function resetExclusions() {
            if (!confirm('Are you sure you want to reset all customer exclusions?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/settings/reset-exclusions', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showStatus('Exclusions reset successfully');
                    loadStatistics();
                } else {
                    throw new Error('Failed to reset exclusions');
                }
            } catch (error) {
                showStatus('Error resetting exclusions', 'error');
            }
        }

        // Clear upload history
        async function clearUploadHistory() {
            if (!confirm('Are you sure you want to clear all upload history?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/settings/clear-upload-history', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showStatus('Upload history cleared successfully');
                    loadStatistics();
                } else {
                    throw new Error('Failed to clear upload history');
                }
            } catch (error) {
                showStatus('Error clearing upload history', 'error');
            }
        }

        // ============================================
        // USER MANAGEMENT FUNCTIONS
        // ============================================

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    users = await response.json();
                    displayUsers();
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showStatus('Error loading users', 'error');
            }
        }

        // Display users in table
        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            const noUsersMessage = document.getElementById('noUsersMessage');
            
            if (users.length === 0) {
                tbody.innerHTML = '';
                noUsersMessage.style.display = 'block';
                return;
            }
            
            noUsersMessage.style.display = 'none';
            tbody.innerHTML = users.map(user => `
                <tr class="user-row">
                    <td>${user.id}</td>
                    <td style="font-weight: bold;">${user.username}</td>
                    <td>${user.email || '-'}</td>
                    <td>
                        <span style="text-transform: capitalize;">${user.role || 'viewer'}</span>
                    </td>
                    <td style="text-align: center;">
                        <span class="status-badge ${user.active ? 'status-active' : 'status-inactive'}">
                            ${user.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="editUser(${user.id})" class="btn-small" style="margin-right: 5px;">Edit</button>
                        <button onclick="deleteUser(${user.id})" class="btn-danger btn-small">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Reset user form
        function resetUserForm() {
            editingUserId = null;
            document.getElementById('userForm').reset();
            document.getElementById('userFormTitle').textContent = 'Create New User';
            document.getElementById('saveUserBtn').textContent = 'Create User';
            document.getElementById('password').required = true;
            document.getElementById('active').checked = true;
            document.getElementById('role').value = 'viewer';
            document.getElementById('editingUserId').value = '';
            
            // Scroll to top of form if needed
            document.getElementById('users-tab').scrollIntoView({ behavior: 'smooth' });
        }

        // Edit user
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            editingUserId = userId;
            document.getElementById('userFormTitle').textContent = 'Edit User';
            document.getElementById('saveUserBtn').textContent = 'Update User';
            document.getElementById('editingUserId').value = userId;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email || '';
            document.getElementById('role').value = user.role || 'viewer';
            document.getElementById('active').checked = user.active;
            document.getElementById('password').required = false;
            document.getElementById('password').value = '';
            
            // Scroll to form
            document.getElementById('users-tab').scrollIntoView({ behavior: 'smooth' });
        }

        // Handle user form submit
        async function handleUserSubmit(e) {
            e.preventDefault();
            
            const editingId = document.getElementById('editingUserId').value;
            
            const formData = {
                username: document.getElementById('username').value.trim(),
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                active: document.getElementById('active').checked
            };
            
            // Validate
            if (!formData.username) {
                showStatus('Username is required', 'error');
                return;
            }
            
            if (!editingId && !formData.password) {
                showStatus('Password is required for new users', 'error');
                return;
            }
            
            if (formData.password && formData.password.length < 6) {
                showStatus('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                const url = editingId ? `/api/users/${editingId}` : '/api/users';
                const method = editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showStatus(editingId ? 'User updated successfully' : 'User created successfully');
                    resetUserForm();
                    loadUsers();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save user');
                }
            } catch (error) {
                showStatus('Error saving user: ' + error.message, 'error');
            }
        }

        // Delete user
        async function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (!confirm(`Are you sure you want to delete user "${user.username}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showStatus('User deleted successfully');
                    
                    // If we were editing this user, reset the form
                    if (editingUserId === userId) {
                        resetUserForm();
                    }
                    
                    loadUsers();
                } else {
                    throw new Error('Failed to delete user');
                }
            } catch (error) {
                showStatus('Error deleting user: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
