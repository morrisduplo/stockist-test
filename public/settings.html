<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Antenne Books Stockist Database</title>
    
    <!-- Authentication Check Script -->
    <script>
        // Authentication check for protected pages
        (function() {
            // Check authentication
            const session = localStorage.getItem('userSession');
            
            if (!session) {
                // No session, redirect to login
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const sessionData = JSON.parse(session);
                
                // Check if session is still valid
                const maxAge = sessionData.remember ? 30 * 24 * 60 * 60 * 1000 : 24 * 60 * 60 * 1000;
                if (new Date() - new Date(sessionData.timestamp) > maxAge) {
                    // Session expired
                    localStorage.removeItem('userSession');
                    window.location.href = '/login.html';
                    return;
                }
                
                // Check if user is admin
                if (sessionData.role !== 'admin') {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = '/';
                    return;
                }
                
                // Store user info globally for the page to use
                window.currentUser = sessionData;
                
            } catch (e) {
                // Invalid session data
                localStorage.removeItem('userSession');
                window.location.href = '/login.html';
            }
        })();
        
        function logout() {
            localStorage.removeItem('userSession');
            window.location.href = '/login.html';
        }
    </script>
    
    <!-- Import Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier', monospace;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            padding: 20px;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'EB Garamond', serif;
            font-weight: 400;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #f1f3f4;
            padding-bottom: 20px;
        }

        h1 {
            color: #333333;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            font-size: 13px;
            color: #666;
        }

        .user-info strong {
            color: #333;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-logout:hover {
            background: #c82333;
        }

        .back-link {
            color: #666;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid #666;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: #f1f3f4;
        }

        .settings-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .settings-section h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #555;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier', monospace;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 10px;
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .mapping-row input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier', monospace;
            font-size: 12px;
        }

        button {
            background: #000000;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background: #333333;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .status-message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #004085;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .import-export-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .import-export-box {
            flex: 1;
            padding: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .import-export-box h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .file-input-wrapper {
            margin: 15px 0;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .file-input-label:hover {
            background: #0056b3;
        }

        .file-name {
            margin-left: 10px;
            color: #666;
            font-size: 13px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .setting-description {
            flex: 1;
        }

        .setting-description h4 {
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }

        .setting-description p {
            color: #666;
            font-size: 12px;
            margin: 0;
        }

        .tab-container {
            margin-bottom: 30px;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .tab-button.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .danger-zone {
            background: #fff5f5;
            border: 2px solid #dc3545;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .danger-zone h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .danger-zone p {
            color: #721c24;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .user-row:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Settings</h1>
            <div class="header-right">
                <span class="user-info">Logged in as: <strong id="currentUserName">User</strong></span>
                <button class="btn-logout" onclick="logout()">Logout</button>
                <a href="/" class="back-link">‚Üê Back to Dashboard</a>
            </div>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <div class="tab-buttons">
                <div class="tab-button active" onclick="switchTab('general')">General Settings</div>
                <div class="tab-button" onclick="switchTab('mappings')">Customer Name Mappings</div>
                <div class="tab-button" onclick="switchTab('data')">Data Management</div>
                <div class="tab-button" onclick="switchTab('users')">Users</div>
                <div class="tab-button" onclick="switchTab('advanced')">Advanced</div>
            </div>

            <!-- General Settings Tab -->
            <div id="general-tab" class="tab-content active">
                <div class="settings-section">
                    <h2>General Settings</h2>
                    
                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Auto-detect file types</h4>
                            <p>Automatically detect whether uploaded files are Gazelle or Shopify format</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoDetect" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Skip duplicate records</h4>
                            <p>Automatically skip duplicate records during upload based on order reference</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="skipDuplicates" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Default country for unknown locations</h4>
                            <p>Set the default country when location data is missing</p>
                        </div>
                        <select id="defaultCountry" style="width: 200px;">
                            <option value="Unknown">Unknown</option>
                            <option value="UK">United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="FR">France</option>
                            <option value="DE">Germany</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Default city for unknown locations</h4>
                            <p>Set the default city when location data is missing</p>
                        </div>
                        <input type="text" id="defaultCity" value="Unknown" style="width: 200px;">
                    </div>

                    <div class="action-buttons">
                        <button onclick="saveGeneralSettings()">Save General Settings</button>
                    </div>
                </div>
            </div>

            <!-- Customer Name Mappings Tab -->
            <div id="mappings-tab" class="tab-content">
                <div class="settings-section">
                    <h2>Customer Name Mappings</h2>
                    
                    <div class="info-box">
                        <strong>How it works:</strong>
                        Configure automatic customer name replacements here. When data is uploaded, any customer name matching the "Original Name" will be automatically replaced with the "Display Name". This helps maintain consistent customer records across different data sources.
                    </div>

                    <h3>Current Mappings</h3>
                    <div id="mappingsList">
                        <!-- Mappings will be loaded here -->
                    </div>

                    <h3>Add New Mapping</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Original Name</label>
                            <input type="text" id="originalName" placeholder="e.g., ANTENNE - DIRECT UK">
                        </div>
                        <div class="form-group">
                            <label>Display Name</label>
                            <input type="text" id="displayName" placeholder="e.g., Antenne Online UK">
                        </div>
                        <button onclick="addMapping()" class="btn-success">Add Mapping</button>
                    </div>
                </div>
            </div>

            <!-- Data Management Tab -->
            <div id="data-tab" class="tab-content">
                <div class="settings-section">
                    <h2>Data Management</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRecords">-</div>
                            <div class="stat-label">Total Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalCustomers">-</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTitles">-</div>
                            <div class="stat-label">Unique Titles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="excludedCustomers">-</div>
                            <div class="stat-label">Excluded Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalBooksonix">-</div>
                            <div class="stat-label">Booksonix Records</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Backup & Export</h3>
                    <div class="import-export-section">
                        <div class="import-export-box">
                            <h4>Export All Data</h4>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Download a complete backup of all records</p>
                            <button onclick="exportAllData()" class="btn-success">Export All Data</button>
                        </div>
                        
                        <div class="import-export-box">
                            <h4>Backup Database</h4>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Create a database backup</p>
                            <button onclick="backupDatabase()" class="btn-secondary">Create Backup</button>
                        </div>
                    </div>

                    <div class="danger-zone">
                        <h3>Danger Zone</h3>
                        <p>These actions are irreversible. Please be certain before proceeding.</p>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button onclick="clearAllData()" class="btn-danger">Clear All Sales Records</button>
                            <button onclick="resetExclusions()" class="btn-danger">Reset All Exclusions</button>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="clearBooksonixData()" class="btn-danger">Clear All Booksonix Records</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content">
                <div class="settings-section">
                    <h2>User Management</h2>
                    
                    <div class="info-box">
                        <strong>Manage System Users:</strong>
                        Create and manage user accounts for accessing the Antenne Books Stockist Database. Control who can view, upload, and manage data in your system.
                    </div>

                    <!-- Add User Button -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="openAddUserModal()" class="btn-success">+ Add New User</button>
                    </div>

                    <!-- Users Table -->
                    <h3>Existing Users</h3>
                    <div id="usersTableContainer">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #34495e; color: white;">
                                    <th style="padding: 12px; text-align: left;">Username</th>
                                    <th style="padding: 12px; text-align: left;">Email</th>
                                    <th style="padding: 12px; text-align: left;">Role</th>
                                    <th style="padding: 12px; text-align: center;">Created</th>
                                    <th style="padding: 12px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                        <div id="noUsersMessage" style="display: none; text-align: center; padding: 40px; color: #7f8c8d;">
                            No users found. Create your first user above.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div id="advanced-tab" class="tab-content">
                <div class="settings-section">
                    <h2>Advanced Settings</h2>
                    
                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Records per page</h4>
                            <p>Number of records to display per page in the upload view</p>
                        </div>
                        <input type="number" id="recordsPerPage" value="500" min="100" max="1000" step="100" style="width: 100px;">
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Enable debug logging</h4>
                            <p>Show detailed logging information in the browser console</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="debugLogging">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-description">
                            <h4>Database connection timeout (seconds)</h4>
                            <p>Maximum time to wait for database operations</p>
                        </div>
                        <input type="number" id="dbTimeout" value="30" min="10" max="120" style="width: 100px;">
                    </div>

                    <div class="action-buttons">
                        <button onclick="saveAdvancedSettings()">Save Advanced Settings</button>
                    </div>

                    <h3 style="margin-top: 30px;">System Information</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                        <p>Application Version: 1.0.0</p>
                        <p>Database: PostgreSQL on Railway</p>
                        <p>Node.js Version: 18.x</p>
                        <p>Last Updated: <span id="lastUpdated">-</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Modal for Add/Edit User -->
    <div id="userModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px; max-width: 90%;">
            <h3 id="modalTitle" style="margin-bottom: 20px;">Add New User</h3>
            <form id="userForm">
                <input type="hidden" id="editingUserId">
                
                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email">
                </div>
                
                <div class="form-group">
                    <label for="password">Password *</label>
                    <input type="password" id="password">
                    <small style="color: #666; font-size: 11px;">Leave blank when editing to keep existing password</small>
                </div>
                
                <div class="form-group">
                    <label for="role">Role *</label>
                    <select id="role" required>
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="editor">Editor (Can Upload & Edit)</option>
                        <option value="admin">Admin (Full Access)</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="closeUserModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-success">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Display current user
        if (window.currentUser) {
            document.getElementById('currentUserName').textContent = window.currentUser.username;
        }

        let currentMappings = [];
        let users = [];

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'mappings') {
                loadMappings();
            } else if (tabName === 'data') {
                loadStatistics();
            } else if (tabName === 'users') {
                loadUsers();
            }
        }

        // Show status message
        function showStatus(message, type = 'success') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Load mappings
        async function loadMappings() {
            try {
                const response = await fetch('/api/mappings');
                if (response.ok) {
                    currentMappings = await response.json();
                    displayMappings();
                }
            } catch (error) {
                console.error('Error loading mappings:', error);
                showStatus('Error loading mappings', 'error');
            }
        }

        // Display current mappings
        function displayMappings() {
            const container = document.getElementById('mappingsList');
            
            if (!currentMappings || currentMappings.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No mappings configured yet</p>';
                return;
            }
            
            container.innerHTML = currentMappings.map(mapping => `
                <div class="mapping-row">
                    <input type="text" value="${mapping.original_name}" readonly style="background: #f8f9fa;">
                    <input type="text" value="${mapping.display_name}" readonly style="background: #f8f9fa;">
                    <button onclick="removeMapping(${mapping.id})" class="btn-danger btn-small">Remove</button>
                </div>
            `).join('');
        }

        // Add new mapping
        async function addMapping() {
            const originalName = document.getElementById('originalName').value.trim();
            const displayName = document.getElementById('displayName').value.trim();
            
            if (!originalName || !displayName) {
                showStatus('Please enter both original and display names', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/mappings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        original_name: originalName, 
                        display_name: displayName 
                    })
                });
                
                if (response.ok) {
                    showStatus('Mapping added successfully');
                    document.getElementById('originalName').value = '';
                    document.getElementById('displayName').value = '';
                    loadMappings();
                } else {
                    throw new Error('Failed to add mapping');
                }
            } catch (error) {
                showStatus('Error adding mapping', 'error');
            }
        }

        // Remove mapping
        async function removeMapping(id) {
            if (!confirm('Are you sure you want to remove this mapping?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/mappings/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showStatus('Mapping removed successfully');
                    loadMappings();
                } else {
                    throw new Error('Failed to remove mapping');
                }
            } catch (error) {
                showStatus('Error removing mapping', 'error');
            }
        }

        // Load statistics - UPDATED to include Booksonix count
        async function loadStatistics() {
            try {
                // Load main stats
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalRecords').textContent = (stats.total_records || 0).toLocaleString();
                    document.getElementById('totalCustomers').textContent = (stats.total_customers || 0).toLocaleString();
                    document.getElementById('totalTitles').textContent = (stats.total_titles || 0).toLocaleString();
                    document.getElementById('excludedCustomers').textContent = (stats.excluded_customers || 0).toLocaleString();
                }
                
                // Load Booksonix stats
                const booksonixResponse = await fetch('/api/booksonix/stats');
                if (booksonixResponse.ok) {
                    const booksonixStats = await booksonixResponse.json();
                    document.getElementById('totalBooksonix').textContent = (booksonixStats.totalRecords || 0).toLocaleString();
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Save general settings
        async function saveGeneralSettings() {
            const settings = {
                autoDetect: document.getElementById('autoDetect').checked,
                skipDuplicates: document.getElementById('skipDuplicates').checked,
                defaultCountry: document.getElementById('defaultCountry').value,
                defaultCity: document.getElementById('defaultCity').value
            };
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    showStatus('General settings saved successfully');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                showStatus('Error saving settings', 'error');
            }
        }

        // Save advanced settings
        async function saveAdvancedSettings() {
            const settings = {
                recordsPerPage: document.getElementById('recordsPerPage').value,
                debugLogging: document.getElementById('debugLogging').checked,
                dbTimeout: document.getElementById('dbTimeout').value
            };
            
            showStatus('Advanced settings saved successfully');
        }

        // Export all data
        async function exportAllData() {
            try {
                const response = await fetch('/api/export-all');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `stockist_data_export_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showStatus('Data exported successfully');
                } else {
                    throw new Error('Export failed');
                }
            } catch (error) {
                showStatus('Error exporting data', 'error');
            }
        }

        // Backup database
        async function backupDatabase() {
            try {
                const response = await fetch('/api/backup');
                if (response.ok) {
                    showStatus('Database backup created successfully');
                } else {
                    throw new Error('Backup failed');
                }
            } catch (error) {
                showStatus('Error creating backup', 'error');
            }
        }

        // Clear all sales data - UPDATED with proper API call
        async function clearAllData() {
            if (!confirm('Are you sure you want to DELETE ALL SALES RECORDS? This cannot be undone!')) {
                return;
            }
            
            if (!confirm('This will permanently delete ALL sales records, upload history, and customer exclusions. Are you absolutely sure?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-data', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showStatus('All sales records cleared successfully');
                    loadStatistics();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to clear records');
                }
            } catch (error) {
                showStatus('Error clearing records: ' + error.message, 'error');
            }
        }

        // Clear all Booksonix data - NEW FUNCTION
        async function clearBooksonixData() {
            if (!confirm('Are you sure you want to DELETE ALL BOOKSONIX RECORDS? This cannot be undone!')) {
                return;
            }
            
            if (!confirm('This will permanently delete ALL Booksonix inventory records. Are you absolutely sure?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear-booksonix', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus(result.message || 'All Booksonix records cleared successfully');
                    loadStatistics(); // Refresh the stats
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to clear Booksonix records');
                }
            } catch (error) {
                showStatus('Error clearing Booksonix records: ' + error.message, 'error');
            }
        }

        // Reset exclusions - UPDATED with proper API call
        async function resetExclusions() {
            if (!confirm('Are you sure you want to reset all customer exclusions?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/reset-exclusions', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus(result.message || 'Exclusions reset successfully');
                    loadStatistics();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to reset exclusions');
                }
            } catch (error) {
                showStatus('Error resetting exclusions: ' + error.message, 'error');
            }
        }

        // User Management Functions
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    users = await response.json();
                    displayUsers();
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showStatus('Error loading users', 'error');
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            const noUsersMessage = document.getElementById('noUsersMessage');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '';
                noUsersMessage.style.display = 'block';
                return;
            }
            
            noUsersMessage.style.display = 'none';
            tbody.innerHTML = users.map(user => `
                <tr class="user-row">
                    <td style="padding: 12px; font-weight: bold;">${user.username}</td>
                    <td style="padding: 12px;">${user.email || '-'}</td>
                    <td style="padding: 12px;">
                        <span style="text-transform: capitalize;">${user.role || 'viewer'}</span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${new Date(user.created_at).toLocaleDateString()}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="editUser(${user.id})" class="btn-small" style="margin-right: 5px;">Edit</button>
                        <button onclick="deleteUser(${user.id})" class="btn-danger btn-small">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function openAddUserModal() {
            document.getElementById('modalTitle').textContent = 'Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('editingUserId').value = '';
            document.getElementById('password').required = true;
            document.getElementById('userModal').style.display = 'block';
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('editingUserId').value = userId;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email || '';
            document.getElementById('role').value = user.role || 'viewer';
            document.getElementById('password').value = '';
            document.getElementById('password').required = false;
            document.getElementById('userModal').style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('userForm').reset();
        }

        async function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (!confirm(`Are you sure you want to delete user "${user.username}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showStatus('User deleted successfully');
                    loadUsers();
                } else {
                    throw new Error('Failed to delete user');
                }
            } catch (error) {
                showStatus('Error deleting user', 'error');
            }
        }

        // User form submission
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const editingId = document.getElementById('editingUserId').value;
            const userData = {
                username: document.getElementById('username').value.trim(),
                email: document.getElementById('email').value.trim(),
                role: document.getElementById('role').value
            };
            
            const password = document.getElementById('password').value;
            if (password) {
                userData.password = password;
            }
            
            if (!editingId && !password) {
                showStatus('Password is required for new users', 'error');
                return;
            }
            
            try {
                const url = editingId ? `/api/users/${editingId}` : '/api/users';
                const method = editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    showStatus(editingId ? 'User updated successfully' : 'User created successfully');
                    closeUserModal();
                    loadUsers();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save user');
                }
            } catch (error) {
                showStatus('Error saving user: ' + error.message, 'error');
            }
        });

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadMappings();
            loadStatistics();
            loadUsers();
            
            // Set last updated
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        });
    </script>
</body>
</html>
